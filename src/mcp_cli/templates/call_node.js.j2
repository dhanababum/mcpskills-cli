#!/usr/bin/env node
// Call MCP tool on server '{{ server_name }}'
const fs = require("fs");
const path = require("path");

const SERVER = "{{ server_name }}";
const CREDS_FILE = path.join(process.env.HOME, ".mcps", "credentials");

function loadCredentials() {
  const text = fs.readFileSync(CREDS_FILE, "utf-8");
  const section = new RegExp(`\\[${SERVER}\\]([\\s\\S]*?)(?=\\n\\[|$)`);
  const match = text.match(section);
  if (!match) {
    console.error(`No section [${SERVER}] in ${CREDS_FILE}`);
    process.exit(1);
  }
  const block = match[1];
  const url = block.match(/^url\s*=\s*(.+)$/m)?.[1]?.trim();
  const token = block.match(/^token\s*=\s*(.+)$/m)?.[1]?.trim();
  if (!url || !token) {
    console.error(`Missing url or token for [${SERVER}]`);
    process.exit(1);
  }
  return { url: url.replace(/\/?$/, "/"), token };
}

async function callTool(toolName, args) {
  const { url, token } = loadCredentials();
  const body = JSON.stringify({
    jsonrpc: "2.0",
    method: "tools/call",
    params: { name: toolName, arguments: args },
    id: 1,
  });
  const resp = await fetch(url, {
    method: "POST",
    headers: {
      Authorization: `Bearer ${token}`,
      "Content-Type": "application/json",
      Accept: "application/json, text/event-stream",
      "MCP-Protocol-Version": "2025-06-18",
    },
    body,
  });
  const text = await resp.text();
  for (const line of text.split("\n")) {
    let data = line.startsWith("data:") ? line.slice(5).trim() : line.trim();
    if (!data || data === "[DONE]") continue;
    try {
      const obj = JSON.parse(data);
      if (obj.result || obj.error) return obj;
    } catch {}
  }
  return JSON.parse(text);
}

const [toolName, rawArgs] = process.argv.slice(2);
if (!toolName) {
  console.error(`Usage: ${process.argv[1]} <tool_name> [json_args]`);
  process.exit(1);
}
const args = rawArgs ? JSON.parse(rawArgs) : {};
callTool(toolName, args).then((r) => console.log(JSON.stringify(r, null, 2)));
